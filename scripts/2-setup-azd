#!/bin/bash

# Setup Azure Developer CLI (azd) Script
# Simple setup script for AI agents lab

set -e  # Exit on any error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# ---------------------
# Check Prerequisites
# ---------------------

echo "→ Checking prerequisites..."

# Check if azd is installed
if ! command -v azd >/dev/null 2>&1; then
    print_error "Azure Developer CLI (azd) is not installed"
    echo "Please install azd first: https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd"
    exit 1
else
    azd_version=$(azd version | head -n 1)
    print_success "Azure Developer CLI found: $azd_version"
fi

# Check if az is installed
if ! command -v az >/dev/null 2>&1; then
    print_error "Azure CLI (az) is not installed"
    echo "Please install Azure CLI first: https://docs.microsoft.com/cli/azure/install-azure-cli"
    exit 1
else
    az_version=$(az version --query '"azure-cli"' -o tsv)
    print_success "Azure CLI found: $az_version"
fi

# ---------------------
# Setup .azd Directory
# ---------------------

echo "→ Setting up .azd directory..."

if [ ! -d ".azd" ]; then
    mkdir -p .azd
    print_success "Created .azd directory"
else
    print_success ".azd directory already exists"
fi

# ---------------------
# Initialize AI Agents Template
# ---------------------

echo "→ Initializing AI agents template..."

cd .azd

# Initialize with the AI agents template using MSIGNITE25-LAB516 as environment name
azd init -t get-started-with-ai-agents -e MSIGNITE25-LAB516

print_success "AI agents template initialized successfully with environment: MSIGNITE25-LAB516"

# Enable Azure Monitor tracing
azd env set ENABLE_AZURE_MONITOR_TRACING true

print_success "Azure Monitor tracing enabled"

# Enable Azure tracing Gen AI content recording
azd env set AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED true

print_success "Azure tracing Gen AI content recording enabled"

# Set Azure location
azd env set AZURE_LOCATION swedencentral

print_success "Azure location set to swedencentral"

# Set Azure AI agent model configuration
azd env set AZURE_AI_AGENT_MODEL_NAME gpt-4.1
azd env set AZURE_AI_AGENT_MODEL_VERSION 2025-04-14

print_success "Azure AI agent model configured: gpt-4.1 (version: 2025-04-14)"

# Set Azure AI agent deployment capacity
azd env set AZURE_AI_AGENT_DEPLOYMENT_CAPACITY 100
azd env set AZURE_AI_EMBED_DEPLOYMENT_CAPACITY 50

print_success "Azure AI agent deployment capacity set to 100"
print_success "Azure AI embed deployment capacity set to 50"

# Set Azure AI Search configuration
export USE_AZURE_AI_SEARCH_SERVICE="true"
export AZURE_AI_SEARCH_INDEX_NAME="zava-products"
export AZURE_AI_EMBED_DEPLOYMENT_NAME="text-embedding-3-large"

print_success "Azure AI Search configuration exported"

# Customize Azure resource names
azd env set AZURE_AIPROJECT_NAME lab516-aiproject
azd env set AZURE_AISERVICES_NAME lab516-airesource

print_success "Azure resource names customized"

echo ""
print_success "Setup complete! You can now work with the AI agents template."